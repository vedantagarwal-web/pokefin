<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orthogonal Research Terminal</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="whiteboard">
  <!-- Header -->
  <header class="whiteboard-header">
    <div class="whiteboard-brand">
      <span class="logo">‚ä•</span>
      <span class="logo-text">Orthogonal</span>
      <span style="margin-left: 12px; color: var(--color-text-tertiary); font-size: 13px;">Research Terminal</span>
    </div>
  </header>

  <!-- Loading State -->
  <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 80vh; color: var(--color-text-secondary);">
    <div style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 16px;">‚ä•</div>
      <div style="font-size: 16px;">Loading research data...</div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="content" class="whiteboard-content" style="display: none;"></div>

  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const ticker = urlParams.get('ticker');

    if (!ticker) {
      document.getElementById('loading').innerHTML = `
        <div style="text-align: center; color: var(--color-text-secondary);">
          <div style="font-size: 48px; margin-bottom: 16px;">‚ä•</div>
          <div style="font-size: 18px; margin-bottom: 8px;">Ticker Not Specified</div>
          <div style="font-size: 14px;">Please provide a ticker symbol in the URL.</div>
        </div>
      `;
    } else {
      document.title = `${ticker} Research ‚Äî Orthogonal Terminal`;
      loadResearch(ticker);
    }

    async function loadResearch(ticker) {
      try {
        const response = await fetch(`http://localhost:8788/api/research/${ticker}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            document.getElementById('loading').innerHTML = `
              <div style="text-align: center; color: var(--color-text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ä•</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Research Not Found</div>
                <div style="font-size: 14px;">Run deep research on ${ticker} first.</div>
                <div style="margin-top: 24px;">
                  <a href="chat.html" style="color: var(--color-accent); text-decoration: none; font-weight: 600;">‚Üê Back to Terminal</a>
                </div>
              </div>
            `;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
          return;
        }
        
        const data = await response.json();
        console.log('üìä Research data:', data);
        renderResearch(data);
        
      } catch (e) {
        console.error('Error loading research:', e);
        document.getElementById('loading').innerHTML = `
          <div style="text-align: center; color: var(--color-text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">‚ä•</div>
            <div style="font-size: 18px; margin-bottom: 8px;">Error Loading Data</div>
            <div style="font-size: 14px;">${e.message}</div>
            <div style="margin-top: 24px;">
              <a href="chat.html" style="color: var(--color-accent); text-decoration: none; font-weight: 600;">‚Üê Back to Terminal</a>
            </div>
          </div>
        `;
      }
    }

    function renderResearch(data) {
      const content = document.getElementById('content');
      const loading = document.getElementById('loading');
      
      // Build HTML
      let html = `
        <!-- Executive Summary -->
        <div class="section" style="background: var(--color-surface); border: 1px solid var(--color-accent);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
              <h1 style="font-size: 36px; font-weight: 700; margin-bottom: 8px;">${data.ticker}</h1>
              <div style="display: flex; gap: 16px; align-items: center;">
                <span style="padding: 4px 16px; border-radius: 6px; font-size: 14px; font-weight: 700; letter-spacing: 0.5px; ${data.recommendation === 'BUY' ? 'background: rgba(48, 209, 88, 0.2); color: var(--color-success);' : data.recommendation === 'SELL' ? 'background: rgba(255, 69, 58, 0.2); color: var(--color-danger);' : 'background: rgba(161, 161, 166, 0.2); color: var(--color-text-secondary);'}">${data.recommendation}</span>
                <span style="font-size: 18px; color: var(--color-text-secondary);">Conviction: ${data.conviction}/10 ${'‚≠ê'.repeat(data.conviction)}</span>
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 32px; font-weight: 600; font-family: var(--font-mono);">$${data.current_price ? data.current_price.toFixed(2) : 'N/A'} ‚Üí $${data.target_price ? data.target_price.toFixed(2) : 'N/A'}</div>
              <div style="font-size: 16px; color: ${(data.upside_pct || 0) > 0 ? 'var(--color-success)' : 'var(--color-danger)'};">${(data.upside_pct || 0) > 0 ? '+' : ''}${(data.upside_pct || 0).toFixed(1)}%</div>
            </div>
          </div>
          <div style="padding: 20px; background: var(--color-surface-elevated); border-radius: 8px; border-left: 3px solid var(--color-accent);">
            <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px;">Investment Thesis</div>
            <p style="font-size: 15px; line-height: 1.7; color: var(--color-text-primary);">${data.thesis || data.key_thesis || 'No thesis available'}</p>
          </div>
        </div>

        ${renderMarketData(data)}
        ${renderFundamentals(data)}
        ${renderHistoricalCharts(data)}
        ${renderPeerComparison(data)}
        ${renderFinancialStatements(data)}
        ${renderBalanceSheet(data)}
        ${renderCashFlow(data)}
        ${renderSECFilings(data)}
        ${renderEarningsHighlights(data)}
        ${renderSocialSentiment(data)}
        ${renderInstitutional(data)}
        ${renderNews(data)}
        ${renderRiskAssessment(data)}
        ${renderBullBearCases(data)}
        ${renderDebateTranscript(data)}
      `;
      
      content.innerHTML = html;
      loading.style.display = 'none';
      content.style.display = 'block';
    }

    function renderMarketData(data) {
      const priceData = data.price_data || data.signals?.price || {};
      return `
        <div class="section">
          <h3>üìà Market Data</h3>
          <div class="data-grid">
            ${renderDataItem('Current Price', priceData.current_price ? '$' + priceData.current_price.toFixed(2) : 'N/A')}
            ${renderDataItem('Market Cap', priceData.market_cap ? formatLargeNumber(priceData.market_cap) : 'N/A')}
            ${renderDataItem('Volume', priceData.volume ? formatVolume(priceData.volume) : 'N/A')}
            ${renderDataItem('Day Change', priceData.day_change_pct ? (priceData.day_change_pct > 0 ? '+' : '') + priceData.day_change_pct.toFixed(2) + '%' : 'N/A')}
          </div>
        </div>
      `;
    }

    function renderFundamentals(data) {
      const fundamentals = data.fundamentals || {};
      const signals = data.signals || {};
      const metrics = signals.financial_metrics || {};
      const finInfo = signals.financials || {};
      
      // Helper to get value from multiple sources
      const getValue = (key) => {
        return fundamentals[key] !== undefined && fundamentals[key] !== null ? fundamentals[key] :
               metrics[key] !== undefined && metrics[key] !== null ? metrics[key] :
               finInfo[key] !== undefined && finInfo[key] !== null ? finInfo[key] : null;
      };
      
      const peRatio = getValue('pe_ratio');
      const profitMargin = getValue('profit_margin');
      const eps = getValue('eps');
      const revenue = getValue('revenue');
      const netIncome = getValue('net_income');
      
      return `
        <div class="section">
          <h3>üí∞ Fundamentals & Valuation</h3>
          <div class="data-grid">
            ${renderDataItem('P/E Ratio', peRatio !== null ? peRatio.toFixed(2) + 'x' : 'N/A')}
            ${renderDataItem('Profit Margin', profitMargin !== null ? profitMargin.toFixed(2) + '%' : 'N/A')}
            ${renderDataItem('EPS (TTM)', eps !== null ? '$' + eps.toFixed(2) : 'N/A')}
            ${renderDataItem('Revenue (TTM)', revenue !== null ? formatLargeNumber(revenue) : 'N/A')}
            ${renderDataItem('Net Income', netIncome !== null ? formatLargeNumber(netIncome) : 'N/A')}
          </div>
          ${renderAnalystRatings(data)}
        </div>
      `;
    }

    function renderAnalystRatings(data) {
      const ratings = data.analyst_ratings || data.signals?.analyst_ratings;
      if (!ratings) return '';
      
      return `
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-border);">
          <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 16px;">Analyst Consensus</div>
          <div class="data-grid">
            ${ratings.consensus ? renderDataItem('Consensus', ratings.consensus) : ''}
            ${ratings.target_price ? renderDataItem('Avg Price Target', '$' + ratings.target_price.toFixed(2)) : ''}
            ${ratings.buy_count !== undefined ? renderDataItem('Buy Ratings', ratings.buy_count) : ''}
            ${ratings.hold_count !== undefined ? renderDataItem('Hold Ratings', ratings.hold_count) : ''}
            ${ratings.sell_count !== undefined ? renderDataItem('Sell Ratings', ratings.sell_count) : ''}
          </div>
        </div>
      `;
    }

    function renderPeerComparison(data) {
      const peerData = data.peer_comparison || data.signals?.peer_comparison;
      if (!peerData || !peerData.comparison || peerData.comparison.length === 0) return '';
      
      return `
        <div class="section">
          <h3>üèÜ Peer Comparison</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Ticker</th>
                <th style="text-align: right;">Price</th>
                <th style="text-align: right;">Market Cap</th>
                <th style="text-align: right;">P/E Ratio</th>
                <th style="text-align: right;">Margin</th>
                <th style="text-align: right;">Revenue (B)</th>
                <th style="text-align: right;">EPS (TTM)</th>
              </tr>
            </thead>
            <tbody>
              ${peerData.comparison.map(comp => {
                const isMain = comp.ticker === data.ticker;
                return `
                  <tr style="${isMain ? 'background: rgba(0, 113, 227, 0.1);' : ''}">
                    <td style="font-weight: ${isMain ? '700' : '500'};">${comp.ticker}${isMain ? ' ‚ä•' : ''}</td>
                    <td style="text-align: right;">$${comp.price ? comp.price.toFixed(2) : 'N/A'}</td>
                    <td style="text-align: right;">${comp.market_cap ? formatLargeNumber(comp.market_cap) : 'N/A'}</td>
                    <td style="text-align: right;">${comp.pe_ratio ? comp.pe_ratio.toFixed(2) + 'x' : 'N/A'}</td>
                    <td style="text-align: right;">${comp.profit_margin ? comp.profit_margin.toFixed(2) + '%' : 'N/A'}</td>
                    <td style="text-align: right;">${comp.revenue ? '$' + comp.revenue.toFixed(2) + 'B' : 'N/A'}</td>
                    <td style="text-align: right;">${comp.eps ? (comp.eps > 0 ? '$' + comp.eps.toFixed(2) : '-$' + Math.abs(comp.eps).toFixed(2)) : 'N/A'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderFinancialStatements(data) {
      const statements = data.financial_statements || data.signals?.financials;
      if (!statements) return '';
      
      return `
        <div class="section">
          <h3>üìä Financial Statements (Latest Quarter)</h3>
          <table class="table">
            <thead>
              <tr>
                <th>Metric</th>
                <th style="text-align: right;">Value</th>
              </tr>
            </thead>
            <tbody>
              ${statements.revenue ? `<tr><td>Revenue</td><td style="text-align: right;">${formatLargeNumber(statements.revenue)}</td></tr>` : ''}
              ${statements.gross_profit ? `<tr><td>Gross Profit</td><td style="text-align: right;">${formatLargeNumber(statements.gross_profit)}</td></tr>` : ''}
              ${statements.operating_income ? `<tr><td>Operating Income</td><td style="text-align: right;">${formatLargeNumber(statements.operating_income)}</td></tr>` : ''}
              ${statements.net_income ? `<tr><td>Net Income</td><td style="text-align: right;">${formatLargeNumber(statements.net_income)}</td></tr>` : ''}
              ${statements.profit_margin_pct ? `<tr><td>Profit Margin</td><td style="text-align: right;">${statements.profit_margin_pct.toFixed(2)}%</td></tr>` : ''}
              ${statements.eps ? `<tr><td>EPS</td><td style="text-align: right;">$${statements.eps.toFixed(2)}</td></tr>` : ''}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderSECFilings(data) {
      const ticker = data.ticker;
      return `
        <div class="section">
          <h3>üìÑ SEC Filings & Documents</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
            <a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${ticker}&type=10-K&dateb=&owner=exclude&count=40" target="_blank" style="padding: 16px; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none; color: var(--color-text-primary); text-align: center; transition: all 0.2s; display: block;">
              <div style="font-size: 20px; margin-bottom: 8px;">üìä</div>
              <div style="font-size: 13px; font-weight: 600;">10-K (Annual)</div>
            </a>
            <a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${ticker}&type=10-Q&dateb=&owner=exclude&count=40" target="_blank" style="padding: 16px; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none; color: var(--color-text-primary); text-align: center; transition: all 0.2s; display: block;">
              <div style="font-size: 20px; margin-bottom: 8px;">üìà</div>
              <div style="font-size: 13px; font-weight: 600;">10-Q (Quarterly)</div>
            </a>
            <a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${ticker}&type=8-K&dateb=&owner=exclude&count=40" target="_blank" style="padding: 16px; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none; color: var(--color-text-primary); text-align: center; transition: all 0.2s; display: block;">
              <div style="font-size: 20px; margin-bottom: 8px;">üì∞</div>
              <div style="font-size: 13px; font-weight: 600;">8-K (Events)</div>
            </a>
            <a href="https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${ticker}&type=&dateb=&owner=exclude&count=40" target="_blank" style="padding: 16px; background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: 8px; text-decoration: none; color: var(--color-text-primary); text-align: center; transition: all 0.2s; display: block;">
              <div style="font-size: 20px; margin-bottom: 8px;">üìÅ</div>
              <div style="font-size: 13px; font-weight: 600;">All Filings</div>
            </a>
          </div>
        </div>
      `;
    }

    function renderSocialSentiment(data) {
      const sentiment = data.sentiment || {};
      if (!sentiment.reddit && !sentiment.twitter) return '';
      
      return `
        <div class="section">
          <h3>üì± Social Sentiment</h3>
          <div class="data-grid">
            ${sentiment.reddit ? `
              <div class="data-item">
                <div class="data-item-label">Reddit</div>
                <div class="data-item-value" style="font-size: 16px; color: ${sentiment.reddit.sentiment === 'VERY BULLISH' || sentiment.reddit.sentiment === 'BULLISH' ? 'var(--color-success)' : sentiment.reddit.sentiment === 'BEARISH' || sentiment.reddit.sentiment === 'VERY BEARISH' ? 'var(--color-danger)' : 'var(--color-text-secondary)'};">${sentiment.reddit.sentiment}</div>
                <div style="font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px;">${sentiment.reddit.bullish_pct}% bullish, ${sentiment.reddit.mentions} mentions</div>
              </div>
            ` : ''}
            ${sentiment.twitter ? `
              <div class="data-item">
                <div class="data-item-label">Twitter</div>
                <div class="data-item-value" style="font-size: 16px; color: ${sentiment.twitter.sentiment === 'VERY BULLISH' || sentiment.twitter.sentiment === 'BULLISH' ? 'var(--color-success)' : sentiment.twitter.sentiment === 'BEARISH' || sentiment.twitter.sentiment === 'VERY BEARISH' ? 'var(--color-danger)' : 'var(--color-text-secondary)'};">${sentiment.twitter.sentiment}</div>
                <div style="font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px;">${sentiment.twitter.bullish_pct}% bullish</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderInstitutional(data) {
      const institutional = data.institutional || {};
      if (Object.keys(institutional).length === 0) return '';
      
      return `
        <div class="section">
          <h3>üè¶ Institutional Activity</h3>
          <div style="font-size: 14px; color: var(--color-text-secondary); line-height: 1.6;">
            ${institutional['13f'] ? `<div style="margin-bottom: 12px;"><strong style="color: var(--color-text-primary);">13F Changes:</strong> ${institutional['13f'].sentiment || 'NEUTRAL'}</div>` : ''}
            ${institutional.insider ? `<div><strong style="color: var(--color-text-primary);">Insider Trades:</strong> ${institutional.insider.summary || 'No recent activity'}</div>` : ''}
          </div>
        </div>
      `;
    }

    function renderNews(data) {
      const news = data.news || [];
      if (news.length === 0) return '';
      
      return `
        <div class="section">
          <h3>üì∞ Recent News</h3>
          <div style="display: flex; flex-direction: column; gap: 16px;">
            ${news.slice(0, 5).map((item, idx) => `
              <div style="padding-bottom: 16px; ${idx < 4 ? 'border-bottom: 1px solid var(--color-border);' : ''}">
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px; color: var(--color-text-primary);">${item.title || item.headline}</div>
                <div style="font-size: 13px; color: var(--color-text-tertiary);">${item.source || ''} ${item.date ? '‚Ä¢ ' + item.date : ''}</div>
                ${item.url ? `<a href="${item.url}" target="_blank" style="font-size: 13px; color: var(--color-accent); text-decoration: none; margin-top: 4px; display: inline-block;">Read more ‚Üí</a>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderRiskAssessment(data) {
      const risks = data.risk_assessment || {};
      if (Object.keys(risks).length === 0) return '';
      
      return `
        <div class="section">
          <h3>‚ö†Ô∏è Risk Assessment</h3>
          <div class="data-grid">
            ${risks.valuation_risk ? renderDataItem('Valuation Risk', risks.valuation_risk, getRiskColor(risks.valuation_risk)) : ''}
            ${risks.volatility_risk ? renderDataItem('Volatility Risk', risks.volatility_risk, getRiskColor(risks.volatility_risk)) : ''}
            ${risks.market_risk ? renderDataItem('Market Risk', risks.market_risk, getRiskColor(risks.market_risk)) : ''}
          </div>
          ${risks.pe_ratio ? `<div style="margin-top: 16px; padding: 12px; background: rgba(255, 69, 58, 0.1); border-radius: 8px; font-size: 13px; color: var(--color-text-secondary);">P/E Ratio: <strong style="color: var(--color-text-primary);">${risks.pe_ratio.toFixed(2)}x</strong></div>` : ''}
        </div>
      `;
    }

    function renderBullBearCases(data) {
      if (!data.bull_case && !data.bear_case) return '';
      
      return `
        <div class="section">
          <h3>‚öñÔ∏è Bull vs Bear Analysis</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            ${data.bull_case ? `
              <div style="padding: 20px; background: rgba(48, 209, 88, 0.1); border: 1px solid rgba(48, 209, 88, 0.3); border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 700; color: var(--color-success); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">üêÇ Bull Case</div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-primary);">${data.bull_case}</p>
              </div>
            ` : ''}
            ${data.bear_case ? `
              <div style="padding: 20px; background: rgba(255, 69, 58, 0.1); border: 1px solid rgba(255, 69, 58, 0.3); border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 700; color: var(--color-danger); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">üêª Bear Case</div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-primary);">${data.bear_case}</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderDebateTranscript(data) {
      const debate = data.debate_transcript || {};
      if (!debate.rounds || debate.rounds.length === 0) return '';
      
      return `
        <div class="section">
          <h3>üó£Ô∏è Multi-Agent Debate Transcript</h3>
          <div style="display: flex; flex-direction: column; gap: 20px;">
            ${debate.rounds.map((round, idx) => `
              <div>
                <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Round ${idx + 1}</div>
                <div style="padding: 16px; background: rgba(48, 209, 88, 0.1); border-left: 3px solid var(--color-success); border-radius: 8px; margin-bottom: 12px;">
                  <div style="font-size: 13px; font-weight: 700; color: var(--color-success); margin-bottom: 8px;">üêÇ Bull Agent:</div>
                  <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-primary);">${round.bull_argument || ''}</p>
                </div>
                <div style="padding: 16px; background: rgba(255, 69, 58, 0.1); border-left: 3px solid var(--color-danger); border-radius: 8px;">
                  <div style="font-size: 13px; font-weight: 700; color: var(--color-danger); margin-bottom: 8px;">üêª Bear Agent:</div>
                  <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-primary);">${round.bear_argument || ''}</p>
                </div>
              </div>
            `).join('')}
            ${debate.winner ? `
              <div style="padding: 20px; background: var(--color-surface-elevated); border: 2px solid var(--color-accent); border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 700; color: var(--color-accent); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Judge Verdict</div>
                <div style="font-size: 16px; margin-bottom: 8px;"><strong>Winner:</strong> ${debate.winner === 'bull' ? 'üêÇ Bull' : 'üêª Bear'} (${debate.confidence}% confidence)</div>
                <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-secondary);">${debate.reasoning || ''}</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderHistoricalCharts(data) {
      const historical = data.historical_financials || data.signals?.historical_financials;
      if (!historical || !historical.periods || historical.periods.length === 0) return '';
      
      return `
        <div class="section">
          <h3>üìà Historical Trends</h3>
          <div style="margin-bottom: 24px;">
            <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Revenue & Income (Last 8 Quarters)</div>
            <table class="table">
              <thead>
                <tr>
                  <th>Period</th>
                  <th style="text-align: right;">Revenue</th>
                  <th style="text-align: right;">Net Income</th>
                  <th style="text-align: right;">Gross Margin</th>
                  <th style="text-align: right;">Op. Margin</th>
                </tr>
              </thead>
              <tbody>
                ${historical.periods.map(p => `
                  <tr>
                    <td>${p.period}</td>
                    <td style="text-align: right;">${formatLargeNumber(p.revenue)}</td>
                    <td style="text-align: right;">${formatLargeNumber(p.net_income)}</td>
                    <td style="text-align: right;">${p.gross_margin ? p.gross_margin.toFixed(1) + '%' : 'N/A'}</td>
                    <td style="text-align: right;">${p.operating_margin ? p.operating_margin.toFixed(1) + '%' : 'N/A'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderBalanceSheet(data) {
      const balanceSheet = data.balance_sheet || data.signals?.balance_sheet;
      if (!balanceSheet) return '';
      
      return `
        <div class="section">
          <h3>üíº Balance Sheet</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
              <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Assets</div>
              <table class="table">
                <tbody>
                  ${balanceSheet.assets?.total_assets ? `<tr><td>Total Assets</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.assets.total_assets)}</td></tr>` : ''}
                  ${balanceSheet.assets?.current_assets ? `<tr><td>Current Assets</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.assets.current_assets)}</td></tr>` : ''}
                  ${balanceSheet.assets?.cash_and_equivalents ? `<tr><td>Cash & Equivalents</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.assets.cash_and_equivalents)}</td></tr>` : ''}
                </tbody>
              </table>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Liabilities & Equity</div>
              <table class="table">
                <tbody>
                  ${balanceSheet.liabilities?.total_liabilities ? `<tr><td>Total Liabilities</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.liabilities.total_liabilities)}</td></tr>` : ''}
                  ${balanceSheet.liabilities?.long_term_debt ? `<tr><td>Long-term Debt</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.liabilities.long_term_debt)}</td></tr>` : ''}
                  ${balanceSheet.equity?.total_equity ? `<tr><td>Total Equity</td><td style="text-align: right;">${formatLargeNumber(balanceSheet.equity.total_equity)}</td></tr>` : ''}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderCashFlow(data) {
      const cashFlow = data.cash_flow || data.signals?.cash_flow;
      if (!cashFlow) return '';
      
      return `
        <div class="section">
          <h3>üí∞ Cash Flow Statement</h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
            <div>
              <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Operating</div>
              <table class="table">
                <tbody>
                  ${cashFlow.operating_activities?.net_income ? `<tr><td>Net Income</td><td style="text-align: right;">${formatLargeNumber(cashFlow.operating_activities.net_income)}</td></tr>` : ''}
                  ${cashFlow.operating_activities?.operating_cash_flow ? `<tr><td>Operating CF</td><td style="text-align: right;">${formatLargeNumber(cashFlow.operating_activities.operating_cash_flow)}</td></tr>` : ''}
                </tbody>
              </table>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Investing</div>
              <table class="table">
                <tbody>
                  ${cashFlow.investing_activities?.capex ? `<tr><td>CapEx</td><td style="text-align: right;">${formatLargeNumber(cashFlow.investing_activities.capex)}</td></tr>` : ''}
                  ${cashFlow.investing_activities?.investing_cash_flow ? `<tr><td>Investing CF</td><td style="text-align: right;">${formatLargeNumber(cashFlow.investing_activities.investing_cash_flow)}</td></tr>` : ''}
                </tbody>
              </table>
            </div>
            <div>
              <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px;">Financing</div>
              <table class="table">
                <tbody>
                  ${cashFlow.financing_activities?.financing_cash_flow ? `<tr><td>Financing CF</td><td style="text-align: right;">${formatLargeNumber(cashFlow.financing_activities.financing_cash_flow)}</td></tr>` : ''}
                  ${cashFlow.free_cash_flow ? `<tr><td><strong>Free Cash Flow</strong></td><td style="text-align: right;"><strong>${formatLargeNumber(cashFlow.free_cash_flow)}</strong></td></tr>` : ''}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderEarningsHighlights(data) {
      const earnings = data.earnings_highlights || data.signals?.earnings_highlights;
      if (!earnings || !earnings.key_quotes) return '';
      
      return `
        <div class="section">
          <h3>üéôÔ∏è Earnings Call Highlights</h3>
          <div style="margin-bottom: 24px;">
            <div style="font-size: 12px; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 16px;">${earnings.latest_call || 'Latest Earnings Call'}</div>
            
            ${earnings.key_quotes && earnings.key_quotes.length > 0 ? `
              <div style="margin-bottom: 24px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Key Management Quotes</div>
                ${earnings.key_quotes.map(quote => `
                  <div style="padding: 16px; background: var(--color-surface-elevated); border-left: 3px solid var(--color-accent); border-radius: 8px; margin-bottom: 12px;">
                    <div style="font-size: 13px; font-weight: 600; color: var(--color-accent); margin-bottom: 8px;">${quote.speaker} - ${quote.context}</div>
                    <p style="font-size: 14px; line-height: 1.6; color: var(--color-text-primary); font-style: italic;">"${quote.quote}"</p>
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            ${earnings.guidance ? `
              <div style="margin-bottom: 24px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Forward Guidance</div>
                <div class="data-grid">
                  ${earnings.guidance.revenue ? renderDataItem('Revenue', earnings.guidance.revenue) : ''}
                  ${earnings.guidance.margins ? renderDataItem('Margins', earnings.guidance.margins) : ''}
                  ${earnings.guidance.outlook ? `<div class="data-item"><div class="data-item-label">Outlook</div><div class="data-item-value" style="font-size: 14px;">${earnings.guidance.outlook}</div></div>` : ''}
                </div>
              </div>
            ` : ''}
            
            ${earnings.analyst_questions && earnings.analyst_questions.length > 0 ? `
              <div>
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Key Q&A</div>
                ${earnings.analyst_questions.map(qa => `
                  <div style="margin-bottom: 16px;">
                    <div style="font-size: 13px; color: var(--color-text-tertiary); margin-bottom: 4px;">Q: ${qa.question}</div>
                    <div style="font-size: 14px; color: var(--color-text-primary);">A: ${qa.answer}</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Helper Functions
    function renderDataItem(label, value, color = null) {
      return `
        <div class="data-item">
          <div class="data-item-label">${label}</div>
          <div class="data-item-value" style="${color ? 'color: ' + color + ';' : ''}">${value}</div>
        </div>
      `;
    }

    function formatLargeNumber(num) {
      if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
      if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return '$' + (num / 1e3).toFixed(2) + 'K';
      return '$' + num.toFixed(2);
    }

    function formatVolume(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toString();
    }

    function getRiskColor(risk) {
      const riskLower = (risk || '').toLowerCase();
      if (riskLower.includes('extreme') || riskLower.includes('very high')) return 'var(--color-danger)';
      if (riskLower.includes('high')) return '#ff9500';
      if (riskLower.includes('medium')) return 'var(--color-warning)';
      return 'var(--color-success)';
    }
  </script>
</body>
</html>
